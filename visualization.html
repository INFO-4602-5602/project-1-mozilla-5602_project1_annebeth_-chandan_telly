
<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font-family: 'Roboto Slab', 'Helvetica Neue', Helvetica, Arial, sans-serif
}

p {
  padding: {top: 20, right: 0, bottom: 20, left: 0};
}

</style>

<body>
<!--Import the D3 Library (version 4 in this case)-->
<script src="https://d3js.org/d3.v4.min.js"></script>

<h1>Something about users and their devices</h1>
<p>
  Lorem ipsum and other things.
</p>
<p>
  Lorem ipsum and other things.
</p>
<div id="visualization_1"></div>
<p>
  Lorem ipsum and other things.
</p>
<div id="visualization_2"></div>

<script>
  // VISUALIZATION 1: HEATMAP
  // Set up the bounds of the visualization
  var margin = { top: 20, right: 40, bottom: 30, left: 100 };
  var width = 600 - margin.right - margin.left;
  var height = 450 - margin.top - margin.bottom;
  var dataset = "preprocessed_data/user_categories.csv";
  var maxCount = 0;

  // Set up the first SVG that gives us a canvas to draw on
  var svg_heatmap = d3.select("#visualization_1").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var userLevel = ["Ultra Nerd",
                  "Technically Savvy",
                  "Average User",
                  "Luddite"]
  var userAttitude = [
              "Scared as hell",
              "A little wary",
              "On the fence",
              "Cautiously optimistic",
              "Super excited!"]

  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(userAttitude)
    .padding(0.01);
  svg_heatmap.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))

  // Build Y scales and axis:
  var y = d3.scaleBand()
    .range([ height, 0 ])
    .domain(userLevel)
    .padding(0.01);
  svg_heatmap.append("g")
    .call(d3.axisLeft(y));

  // Build color scale
  // TODO: Domain is hardcoded, replace.
  var myColor = d3.scaleLinear()
    .range(["white", "#2a5674"])
    .domain([1,32150]);

  // Read the data
  var heatmapChart = function(csvFile) 
  {
    d3.csv(csvFile, function(data) {
    const countList = [];

    data.forEach(function(item){
      countList.push(parseInt(item.counts));
    });
    window.maxCount = d3.max(countList);

    // Build color scale
    var colorBand = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"]
    var myColor = d3.scaleOrdinal()
    .range(colorBand)
    .domain([1,window.maxCount]);

    maxCount = d3.max(data, function(d) { return d.counts; });
    svg_heatmap.selectAll()
        .data(data, function(d) {return d.attitude+':'+d.user_level;})
        .enter()
        .append("rect")
        .attr("x", function(d) { return x(d.attitude) })
        .attr("y", function(d) { return y(d.user_level) })
        .attr("width", x.bandwidth() )
        .attr("height", y.bandwidth() )
        .style("fill", function(d) { return myColor(d.counts)} )
        .attr("class", function(d) { return createClassName(d.user_level, d.attitude) });
  })
  };

  heatmapChart(dataset);
 
  // VISUALIZATION 2: BARPLOT
  // Set up the bounds of the visualization
  var margin = { top: 20, right: 20, bottom: 120, left: 100 };
  var width = 960 - margin.right - margin.left;
  var height = 500 - margin.top - margin.bottom;

  // Set up the second SVG that gives us a canvas to draw on
  var svg_barplot = d3.select("#visualization_2").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Read the data
  d3.csv("../preprocessed_data/devices_per_user_category.csv", function(data) {
    // List of subgroups = header of the csv files = soil condition here
    var subgroups = data.columns.slice(1);

    // List of groups = species here = value of the first column called group -> I show them on the X axis
    var groups = d3.map(data, function(d){return(d.device)}).keys();

    // Add X axis
    var x = d3.scaleBand()
        .domain(groups)
        .range([0, width])
        .padding([0.2])
    svg_barplot.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).tickSizeOuter(0))
      .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end");

    // Add Y axis
    // TODO: Domain is hardcoded, replace.
    var y = d3.scaleLinear()
      .domain([0, 175000])
      .range([ height, 0 ]);
    svg_barplot.append("g")
      .call(d3.axisLeft(y));

    // color palette = one color per subgroup
    // var color = d3.scaleOrdinal()
    //   .domain(subgroups)
    //   .range(["#88CCEE","#CC6677","#DDCC77","#117733",
    //           "#332288","#AA4499","#44AA99","#999933",
    //           "#882255","#661100","#6699CC","#888888",
    //           "#66C5CC","#F6CF71","#F89C74","#DCB0F2"])

    //stack the data? --> stack per subgroup
    var stackedData = d3.stack()
      .keys(subgroups)
      (data)

    // Show the bars
    svg_barplot.append("g")
      .selectAll("g")
      // Enter in the stack data = loop key per key = group per group
      .data(stackedData)
      .enter().append("g")
        .attr("fill", "#CC6677") // function(d) { return color(d.key); })
        .attr("class", function(d){ return fixClassName(d.key) })
        .selectAll("rect")
        // enter a second time = loop subgroup per subgroup to add all rectangles
        .data(function(d) { return d; })
        .enter().append("rect")
          .attr("x", function(d) { return x(d.data.device); })
          .attr("y", function(d) { return y(d[1]); })
          .attr("height", function(d) { return y(d[0]) - y(d[1]); })
          .attr("width", x.bandwidth());
    })

// Function for creating heatmap class names
function createClassName(level, attitude){
  var class_name = level + "_" + attitude;
  return class_name.replace(/ /g, "_");
}

// TODO: Function to shorten the park name
function fixClassName(className){
  return className.substring(1).replace(" x", "").replace(/ /g, "_");
}

// TO-DOs:
// - tooltip on barplot
// - add click on heatmap
// - README!

</script>
